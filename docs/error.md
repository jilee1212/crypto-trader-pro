# 전체 시스템 분석 및 디버깅 종합 프롬프트

## 프로젝트 현황 요약

### 시스템 구성
- **프론트엔드**: React 18 + TypeScript + Ant Design (localhost:5173)
- **백엔드**: FastAPI + SQLAlchemy + SQLite (localhost:8000)
- **목표**: 암호화폐 트레이딩 플랫폼 (메인넷 실거래)

### 핵심 문제
API 키 저장 기능에서 지속적인 SQLAlchemy 세션 오류 발생:
```
"Database error while saving API keys: Instance '<User at 0x...>' is not persistent within this Session"
```

## 종합 분석 및 해결 요청

당신은 이제 이 프로젝트의 **시니어 풀스택 개발자**입니다. 다음과 같이 체계적으로 접근해주세요:

### Phase 1: 전체 아키텍처 분석 (30분)

#### 1.1 프로젝트 구조 완전 분석
```
다음 내용을 상세히 분석하고 보고해주세요:

1. 전체 폴더 구조 매핑
   - backend/ 디렉토리의 모든 Python 파일
   - frontend/ 디렉토리의 주요 TypeScript 파일
   - 설정 파일들 (.env, config.json 등)

2. 데이터 플로우 분석
   - 사용자 로그인 → JWT 토큰 생성 → 인증 → API 호출 전체 흐름
   - FastAPI 라우터 구조와 의존성 주입 패턴
   - SQLAlchemy 모델 관계 및 세션 관리 방식

3. 현재 구현된 기능 현황
   - 완료된 기능 목록
   - 부분 구현된 기능
   - 미구현 기능
```

#### 1.2 SQLAlchemy 세션 관리 구조 분석
```
특히 다음 사항들을 중점적으로 분석해주세요:

1. 데이터베이스 연결 설정
   - database.py의 세션 팩토리 구현 방식
   - get_db() 의존성 함수의 정확한 동작

2. 사용자 인증 시스템
   - get_current_user() 함수가 어떤 세션을 사용하는지
   - JWT 토큰 디코딩과 User 객체 조회 과정
   - 인증 세션과 API 엔드포인트 세션의 관계

3. API 엔드포인트 구조
   - /api/v1/binance/configure-keys의 정확한 구현 내용
   - 의존성 주입 패턴과 세션 스코프
   - 현재 시도된 모든 해결책들의 실제 코드
```

### Phase 2: 근본 원인 진단 (20분)

#### 2.1 SQLAlchemy 세션 문제 정확한 진단
```
다음 가설들을 체계적으로 검증해주세요:

가설 A: 세션 분리 문제
- get_current_user()에서 사용하는 세션과 API 엔드포인트의 db 세션이 다름
- User 객체가 한 세션에서 조회되었지만 다른 세션에서 업데이트 시도

가설 B: 세션 스코프 문제  
- 비동기 처리 중 세션이 예상보다 일찍 종료됨
- 트랜잭션 관리가 올바르지 않음

가설 C: ORM 객체 상태 문제
- User 객체가 detached 또는 expired 상태
- SQLAlchemy lazy loading 문제

각 가설에 대해 코드를 검토하고 실제 원인을 특정해주세요.
```

#### 2.2 로깅 및 디버깅 인프라 부족 분석
```
현재 디버깅이 어려운 이유:

1. 로깅 시스템 부재
   - API 요청이 백엔드에 도달해도 터미널에 로그 없음
   - 예외 처리가 과도해서 실제 오류 위치 파악 불가

2. 개발 도구 부족
   - SQLAlchemy 쿼리 로깅 비활성화
   - 세션 상태 추적 불가능
   - 단계별 디버깅 포인트 없음

이 문제들을 해결하기 위한 방안을 제시하고 구현해주세요.
```

### Phase 3: 종합 해결책 구현 (40분)

#### 3.1 로깅 시스템 구축
```
다음과 같은 종합적인 로깅 시스템을 구현해주세요:

1. FastAPI 요청/응답 로깅
   - 모든 HTTP 요청을 터미널에 출력
   - API 엔드포인트 진입/종료 로그
   - 처리 시간 및 상태 코드 추적

2. SQLAlchemy 쿼리 로깅
   - 실행되는 모든 SQL 쿼리 출력
   - 세션 생성/종료 추적
   - 트랜잭션 상태 모니터링

3. 사용자 인증 디버깅
   - JWT 토큰 디코딩 과정 추적
   - get_current_user() 실행 과정 로깅
   - User 객체 상태 변화 추적

4. API 키 저장 프로세스 상세 로깅
   - configure-keys 엔드포인트의 모든 단계
   - 암호화 과정 추적
   - 데이터베이스 저장 시도 과정
```

#### 3.2 SQLAlchemy 세션 문제 최종 해결
```
로깅 시스템을 통해 정확한 원인을 파악한 후, 
다음 접근법 중 가장 적절한 방법을 선택하여 구현해주세요:

Option 1: 의존성 주입 재설계
- get_current_user()가 세션을 공유하도록 수정
- 또는 사용자 ID만 반환하도록 변경

Option 2: Repository 패턴 도입
- UserRepository 클래스로 모든 DB 작업 캡슐화
- 세션 관리 책임 분리

Option 3: 완전한 Raw SQL 접근
- ORM을 우회하여 직접 SQL UPDATE
- 세션 관리 복잡성 제거

Option 4: 새로운 접근법
- 분석 결과에 따른 완전히 새로운 해결책

선택한 접근법을 완전히 구현하고 테스트해주세요.
```

### Phase 4: 통합 테스트 및 검증 (20분)

#### 4.1 API 키 저장 기능 완전 검증
```
다음과 같은 종합적인 테스트를 수행해주세요:

1. 기본 플로우 테스트
   - 로그인 → API 키 입력 → 저장 → 페이지 이동 → 키 유지 확인

2. 데이터베이스 직접 검증
   - 암호화된 API 키가 실제로 저장되었는지 확인
   - 복호화해서 원본 키와 일치하는지 검증

3. 오류 케이스 테스트
   - 잘못된 API 키 형식
   - 네트워크 오류 시뮬레이션
   - 중복 저장 시도

4. 성능 및 안정성 테스트
   - 연속된 API 키 저장 시도
   - 세션 만료 상황 처리
   - 동시성 문제 확인
```

#### 4.2 다음 기능 준비
```
API 키 저장이 성공한 후 다음 단계들을 준비해주세요:

1. 실제 바이낸스 API 연결 테스트
   - 저장된 키로 계정 정보 조회
   - API 권한 자동 감지 (Spot/Futures)

2. 포트폴리오 정보 로드
   - 실시간 잔고 조회
   - 자산 가치 계산

3. 테스트 모드 완전 제거
   - 하드코딩된 테스트 플래그 모두 제거
   - 실거래 모드 활성화

각 단계별 구현 계획을 제시해주세요.
```

### Phase 5: 코드 품질 및 보안 점검 (10분)

#### 5.1 보안 검토
```
다음 보안 요소들을 점검하고 개선해주세요:

1. API 키 암호화
   - 암호화 강도 확인
   - 마스터 키 관리 방식 검토

2. JWT 토큰 보안
   - 토큰 만료 시간 적절성
   - 토큰 갱신 메커니즘

3. HTTPS/보안 헤더
   - 프로덕션 환경 보안 설정
   - CORS 정책 검토

4. 입력 검증
   - API 키 형식 검증
   - SQL 인젝션 방지
```

#### 5.2 코드 품질 개선
```
다음 사항들을 개선해주세요:

1. 에러 처리
   - 사용자 친화적인 오류 메시지
   - 적절한 HTTP 상태 코드

2. 타입 안정성
   - TypeScript 타입 정의 완성
   - Python 타입 힌트 추가

3. 코드 구조
   - 중복 코드 제거
   - 관심사 분리 개선
```

## 최종 결과물 요구사항

### 완료 후 제공해야 할 내용

1. **상세한 분석 보고서**
   - 발견된 모든 문제점과 원인
   - 적용한 해결책의 근거
   - 아키텍처 개선 사항

2. **작동하는 시스템**
   - API 키 저장/로드 완전 기능
   - 상세한 로깅 시스템
   - 오류 처리 개선

3. **테스트 결과**
   - 모든 기능의 정상 작동 확인
   - 다양한 시나리오 테스트 결과

4. **다음 단계 로드맵**
   - 추가 기능 구현 계획
   - 최적화 방향
   - 운영 환경 배포 준비사항

## 작업 진행 방식

```
이 작업은 다음과 같이 진행해주세요:

1. 각 Phase별로 진행 상황 보고
2. 중요한 발견사항은 즉시 공유
3. 막히는 부분이 있으면 중간 보고
4. 최종 완료 시 종합 리포트 제출

목표: 완전히 작동하는 API 키 저장 시스템 구축
시간: 총 2시간 내외로 체계적 접근
우선순위: 기능 완성 > 코드 완성도 > 최적화
```

## 성공 기준

이 작업이 성공한 것으로 판단하는 기준:

1. API 키 입력 → 저장 → 페이지 이동 → 키 유지 **완벽 작동**
2. 백엔드 터미널에 **상세한 로그 출력**
3. 데이터베이스에 **암호화된 키 정상 저장**
4. 다음 기능(포트폴리오 로드, 실거래 모드) **준비 완료**

---

**시작하세요. 이 프로젝트를 완전히 작동하는 상태로 만들어주세요.**